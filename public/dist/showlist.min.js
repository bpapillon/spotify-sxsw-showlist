!function(t,s,e){"use strict";var i=function(){},n={OFFICIAL:"OFFICIAL",UNOFFICIAL:"UNOFFICIAL"},r=function(){this.spotify_id=null,this.playlists=[],this.artists=[],this.artist_ids=[],this.selected_playlists=[],this.unofficial_pages={},this.shows={OFFICIAL:{},UNOFFICIAL:{}},this.run()};r.prototype={constructor:r,bindEvents:function(){var s=this;t.getElementById("filter-shows").addEventListener("click",function(){s.loadAndRenderShows()},!1),t.getElementById("obtain-new-token").addEventListener("click",function(){s.refreshToken()},!1),t.getElementById("clear-selections").addEventListener("click",function(){s.clearSelections()},!1)},clearSelections:function(){this.artists=[],this.artist_ids=[],this.selected_playlists=[],this.renderArtists(),this.renderPlaylists()},collectArtists:function(t,s){var n=this;"function"!=typeof s&&(s=i),e.ajax({url:t,headers:{Authorization:"Bearer "+n.access_token},success:function(t){var e,i,r,o,a,h=t.tracks.items;for(i=0,r=h.length;r>i;i++)for(e=h[i].track.artists,o=0,a=e.length;a>o;o++)-1===n.artist_ids.indexOf(e[o].id)&&(n.artists.push(e[o]),n.artist_ids.push(e[o].id));s()}})},filterOfficialShows:function(t){var s={},i=this.getArtistNames(),r=this.shows[n.OFFICIAL][t];return e.each(r,function(t,e){i.indexOf(e.artist)>-1&&("undefined"==typeof s[e.artist]&&(s[e.artist]=[]),s[e.artist].push(e))}),s},getArtistNames:function(){return this.artists.map(function(t){return t.name})},getArtistRegexp:function(t){return"undefined"==typeof t&&(t=this.getArtistNames()),new RegExp(t.map(function(t){return"\\b"+t+"\\b"}).join("|"),"i")},getHashParams:function(){for(var t,s={},e=/([^&;=]+)=?([^&;]*)/g,i=window.location.hash.substring(1);t=e.exec(i);)s[t[1]]=decodeURIComponent(t[2]);return s},isLoaded:function(t,s){return this.shows[t]&&this.shows[t][s]&&this.shows[t][s].length>0},loadAndRenderShows:function(){var t=this,s=e("#show-day").val().toLowerCase(),i=e("#show-source").val().toLowerCase();return e("#loading-img").show(),e("#filter-shows").prop("disabled",!0),this.loadShows(i,s,function(){t.renderShows(i,s),e("#loading-img").hide(),e("#filter-shows").prop("disabled",!1)})},loadPlaylists:function(){var t=this,s="https://api.spotify.com/v1/users/"+this.spotify_id+"/playlists",n=function(s,r){return"function"!=typeof r&&(r=i),s?void e.ajax({url:s,data:{limit:50},headers:{Authorization:"Bearer "+t.access_token},success:function(s){var e=s.items.map(function(t){return t.selected=!1,t});t.playlists=t.playlists.concat(e),s.next?n(s.next,r):r()}}):r()};this.playlists=[],n(s,function(){t.renderPlaylists()})},loadShows:function(t,s,r){var o=this;return"function"!=typeof r&&(r=i),t=t.toUpperCase(),this.shows[n[t]]||(this.shows[n[t]]={}),this.isLoaded(n[t],s)?r():(this.shows[n[t]][s]=[],void e.ajax({url:"/shows/"+t.toLowerCase()+"/"+s,success:function(e){e.error?alert(e.error):o.shows[n[t]][s]=e.shows,r()}}))},refreshToken:function(t){"function"!=typeof t&&(t=i),e.ajax({url:"/refresh_token",data:{refresh_token:this.refresh_token}}).done(function(s){this.access_token=s.access_token,t(s)})},renderArtists:function(){var i=t.getElementById("artists-template").innerHTML,n=s.compile(i);t.getElementById("artists").innerHTML=n({artists:this.artists}),e("#artists").show()},renderOfficialShows:function(t){var s=this,i=function(t){return[t.time,t.location].join(" at ")};e("#shows").html(""),e.each(this.filterOfficialShows(t),function(t,n){var r="<p><a href='"+s.sxswSearchUrl(t)+"' target='_blank'>"+t+"</a><br />"+n.map(i).join("<br />")+"</p><br />";e("#shows").append(r)})},renderPlaylists:function(){{var i=t.getElementById("user-playlists-template").innerHTML,n=s.compile(i),r=this;this.playlists.map(function(t){return t.selected=r.selected_playlists.indexOf(t.id)>-1,t})}t.getElementById("user-playlists").innerHTML=n({playlists:this.playlists}),e("#user-playlists").show(),e("#user-playlists li").click(function(){var t=e(this).data("url"),s=e(this).data("id");r.collectArtists(t,function(){r.renderArtists(),r.selected_playlists.push(s)})})},renderShows:function(t,s){return t=t.toUpperCase(),t===n.OFFICIAL?this.renderOfficialShows(s):this.renderUnofficialShows(s)},renderUnofficialShows:function(t){var s=this.getArtistNames(),i=this.getArtistRegexp(s);e("#shows").html(""),0!==s.length&&(e.each(this.shows[n.UNOFFICIAL][t],function(t,s){s.slice(s.indexOf("<li>"),s.length-1).search(i)>-1&&e("#shows").append("<br />"+s)}),e("#shows").highlight(s,{wordsOnly:!0}))},run:function(){var i=t.getElementById("user-profile-template").innerHTML,n=s.compile(i),r=t.getElementById("user-profile"),o=this.getHashParams(),a=this;this.access_token=o.access_token,this.refresh_token=o.refresh_token,this.error_msg=o.error,this.error_msg?alert("There was an error during the authentication"):this.access_token?e.ajax({url:"https://api.spotify.com/v1/me",headers:{Authorization:"Bearer "+this.access_token},success:function(t){a.spotify_id=t.id,r.innerHTML=n(t),a.bindEvents(),e("#login").hide(),e("#loggedin").show(),a.loadPlaylists()}}):(e("#login").show(),e("#loggedin").hide())},sxswSearchUrl:function(t){return"http://schedule.sxsw.com/search?q="+encodeURIComponent(t)+"&conferences%5B%5D=film&conferences%5B%5D=interactive&conferences%5B%5D=music"}},new r}(document,Handlebars,jQuery);